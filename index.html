<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha Market - Plataforma de Inversi√≥n Real</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Carga de Hero Icons para el men√∫ -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .alpha-gradient {
            /* Degradado azul y fuerte */
            background: linear-gradient(90deg, #1e3a8a, #3b82f6);
        }
        .alpha-text-gradient {
            background: linear-gradient(90deg, #1e3a8a, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card-bg {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .loading-ring {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .wallet-address {
            word-break: break-all;
            user-select: all;
        }
        .link-display {
            word-break: break-all;
            font-size: 0.875rem; /* text-sm */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- MODAL DE MENSAJES (Reemplaza a alert()) -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" onclick="hideModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800">Mensaje</h3>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <button onclick="hideModal()" class="w-full alpha-gradient text-white py-2 rounded-lg font-semibold hover:opacity-90 transition duration-200">
                Entendido
            </button>
        </div>
    </div>

    <!-- MODAL DE DEP√ìSITO -->
    <div id="deposit-modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" onclick="hideDepositModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4 alpha-text-gradient">Dep√≥sito de Fondos - Alpha Market</h3>
            
            <form id="deposit-form" class="space-y-4">
                <div>
                    <label for="deposit-amount" class="block text-sm font-medium text-gray-700">Monto a Invertir (M√≠nimo $15.00)</label>
                    <input type="number" step="0.01" min="15.00" id="deposit-amount" required placeholder="Ej: 500.00"
                           class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="deposit-network" class="block text-sm font-medium text-gray-700">Seleccione Red de Dep√≥sito (USDT)</label>
                    <select id="deposit-network" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="updateWalletAddress()">
                        <option value="">-- Seleccionar Red --</option>
                        <option value="USDT BEP20">USDT BEP20</option>
                        <option value="USDT TRC20">USDT TRC20</option>
                    </select>
                </div>

                <!-- Detalles de la Billetera (Din√°mico) -->
                <div id="wallet-details" class="bg-gray-50 p-4 rounded-lg hidden">
                    <p class="text-sm font-medium text-gray-700">Red Seleccionada: <span id="selected-network" class="font-bold text-blue-800"></span></p>
                    <p class="text-sm font-medium text-gray-700 mt-2">Direcci√≥n de Billetera:</p>
                    <div class="flex items-center space-x-2 mt-1 bg-gray-200 p-2 rounded-lg">
                        <span id="wallet-address-display" class="wallet-address text-sm font-mono text-gray-900 flex-grow"></span>
                        <button type="button" onclick="copyWalletAddress()" class="p-1 bg-blue-200 rounded-md hover:bg-blue-300 text-blue-800 transition duration-150">
                            Copiar
                        </button>
                    </div>
                </div>

                <button type="submit" id="deposit-submit-btn" class="w-full py-3 text-white font-bold rounded-lg alpha-gradient hover:opacity-90 transition duration-200 flex justify-center items-center space-x-2">
                    <span id="deposit-submit-text">Confirmar Dep√≥sito</span>
                    <div id="deposit-submit-spinner" class="loading-ring hidden"></div>
                </button>
            </form>
        </div>
    </div>
    
    <!-- MODAL DEL MEN√ö DE NAVEGACI√ìN (Hamburguer Menu) -->
    <div id="menu-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden justify-end" onclick="toggleMenu(false)">
        <div class="bg-white w-64 h-full shadow-2xl transform transition-transform duration-300 ease-in-out translate-x-full" id="menu-drawer" onclick="event.stopPropagation()">
            
            <div class="p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold alpha-text-gradient">Navegaci√≥n</h3>
                <p id="user-display-name-email" class="text-sm text-gray-500 mt-1 truncate"></p>
            </div>
            
            <nav class="flex flex-col p-4 space-y-2">
                <a href="#" onclick="menuNavigate('home')" class="p-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-150 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10l-2-2m2 2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    Inicio
                </a>
                <a href="#" onclick="menuNavigate('dashboard')" id="menu-dashboard-link" class="p-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-150 flex items-center hidden">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.333 0 2.667.5 4 1.5 1.333 1 2 2 2 3s-.667 2-2 3c-1.333 1-2.667 1.5-4 1.5-1.333 0-2.667-.5-4-1.5-1.333-1-2-2-2-3s.667-2 2-3c1.333-1 2.667-1.5 4-1.5z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11a1 1 0 100 2 1 1 0 000-2z"></path></svg>
                    Panel de Inversor
                </a>
                <a href="#" onclick="menuNavigate('referrals')" id="menu-referrals-link" class="p-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-150 flex items-center hidden">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20h-2m2 0h-2M15 4a3 3 0 11-6 0 3 3 0 016 0zM8.56 9.68a2 2 0 100 3.64 2 2 0 000-3.64z"></path></svg>
                    Mis Referidos
                </a>

                <div id="auth-menu-links">
                    <!-- Links de Login/Register o Logout se insertan aqu√≠ -->
                </div>
            </nav>
        </div>
    </div>


    <!-- 1. BARRA DE NAVEGACI√ìN -->
    <header class="bg-white shadow-lg sticky top-0 z-10">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="#" onclick="navigateToView('home')" class="text-3xl font-extrabold alpha-text-gradient">
                Alpha Market
            </a>
            
            <!-- Bot√≥n del men√∫ Hambuguer -->
            <button onclick="toggleMenu(true)" class="p-2 rounded-lg hover:bg-gray-100 transition duration-150">
                <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </nav>
    </header>

    <!-- 2. CONTENIDO PRINCIPAL (Sistema de Vistas SPA) -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 sm:py-20">
        <div id="loading-initial" class="text-center text-gray-600 font-semibold py-20">
            Cargando plataforma de inversi√≥n...
        </div>
        
        <div id="content-container" class="space-y-12">
            
            <!-- VISTA DE INICIO (LANDING PAGE) -->
            <div id="home-view" class="hidden">
                <!-- Contenido de Landing Page -->
                <section class="text-center py-16 sm:py-24 bg-blue-50 rounded-xl">
                    <h1 class="text-4xl sm:text-6xl font-extrabold text-gray-900 leading-tight">
                        Transforma tu Capital con <span class="alpha-text-gradient">Alpha Market</span>
                    </h1>
                    <p class="mt-4 text-xl sm:text-2xl text-gray-600 max-w-3xl mx-auto">
                        La √∫nica plataforma con un **20% de rendimiento diario** garantizado, operando desde Miami.
                    </p>
                    <div class="mt-8 flex justify-center space-x-4">
                        <button onclick="navigateToView('register')" class="px-8 py-3 text-lg font-bold text-white alpha-gradient rounded-full hover:opacity-90 transition duration-300 shadow-xl">
                            Comenzar Ahora
                        </button>
                        <button onclick="navigateToView('login')" class="px-8 py-3 text-lg font-bold text-blue-600 bg-white border-2 border-blue-600 rounded-full hover:bg-blue-50 transition duration-300">
                            Iniciar Sesi√≥n
                        </button>
                    </div>
                </section>

                <section class="py-16 bg-white rounded-xl shadow-lg p-8 mt-12">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-900 mb-4 alpha-text-gradient">
                        Sobre Nosotros: La Visi√≥n Alpha
                    </h2>
                    <p class="text-lg text-gray-600 text-center mb-10 max-w-4xl mx-auto">
                        Nacimos en el coraz√≥n tecnol√≥gico de Miami con la misi√≥n de democratizar la riqueza, ofreciendo herramientas de inversi√≥n de alto rendimiento que antes estaban reservadas solo para √©lites.
                    </p>
                    <div class="grid md:grid-cols-3 gap-8 text-center">
                        <div class="p-4">
                            <h3 class="text-2xl font-bold mb-2 text-blue-800">Misi√≥n</h3>
                            <p class="text-gray-600">Proporcionar una v√≠a de crecimiento financiero exponencial y accesible para cualquier inversor global, con total transparencia y seguridad.</p>
                        </div>
                        <div class="p-4">
                            <h3 class="text-2xl font-bold mb-2 text-blue-800">Visi√≥n</h3>
                            <p class="text-gray-600">Ser el l√≠der indiscutible en rendimientos diarios, redefiniendo el futuro de la capitalizaci√≥n compuesta a nivel internacional.</p>
                        </div>
                        <div class="p-4">
                            <h3 class="text-2xl font-bold mb-2 text-blue-800">Valores</h3>
                            <p class="text-gray-600">Transparencia, Confianza, Innovaci√≥n Continua y un compromiso inquebrantable con el √©xito financiero de nuestros usuarios.</p>
                        </div>
                    </div>
                </section>
                
                <section class="py-12 mt-12">
                    <h2 class="text-3xl font-bold text-center mb-10 text-gray-800">
                        Nuestro Motor de Crecimiento
                    </h2>
                    <div class="grid md:grid-cols-3 gap-8 text-center">
                        <div class="card-bg p-6">
                            <div class="text-5xl alpha-text-gradient mb-3">20%</div>
                            <h3 class="text-xl font-bold mb-2 text-gray-800">Rendimiento Diario Real</h3>
                            <p class="text-gray-600">Aplicamos una tasa de inter√©s compuesto del 20% sobre tu capital todos los d√≠as. Un crecimiento sin precedentes en el mercado.</p>
                        </div>
                        <div class="card-bg p-6">
                            <div class="text-5xl alpha-text-gradient mb-3">‚ö°</div>
                            <h3 class="text-xl font-bold mb-2 text-gray-800">Capitalizaci√≥n Compuesta</h3>
                            <p class="text-gray-600">Tus ganancias se suman al capital, generando rendimientos a√∫n mayores al d√≠a siguiente. El poder del inter√©s compuesto.</p>
                        </div>
                        <div class="card-bg p-6">
                            <div class="text-5xl alpha-text-gradient mb-3">üîí</div>
                            <h3 class="text-xl font-bold mb-2 text-gray-800">Seguridad Total</h3>
                            <p class="text-gray-600">Tu capital est√° protegido en nuestra infraestructura cifrada y asegurada contra ataques cibern√©ticos.</p>
                        </div>
                    </div>
                </section>

                <section class="py-12 bg-white rounded-xl shadow-lg p-8 mt-12">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">
                        Transparencia y Ubicaci√≥n Estrat√©gica
                    </h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-2xl font-bold alpha-text-gradient mb-3 flex items-center">
                                <span class="mr-2">‚öñÔ∏è</span> Marco Regulatorio
                            </h3>
                            <p class="text-gray-600">Alpha Market est√° comprometido con la excelencia y la legalidad. Operamos bajo un **estricto marco de cumplimiento financiero**, supervisado por las autoridades de inversi√≥n digital en los Estados Unidos. Nuestra prioridad es la confianza y la transparencia para todos nuestros inversores globales.</p>
                            <ul class="mt-4 space-y-2 text-gray-700 text-sm">
                                <li>‚Ä¢ Cumplimiento AML (Anti-Lavado de Dinero) riguroso.</li>
                                <li>‚Ä¢ Auditor√≠as de capital peri√≥dicas.</li>
                                <li>‚Ä¢ Protecci√≥n de datos bajo leyes internacionales.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold alpha-text-gradient mb-3 flex items-center">
                                <span class="mr-2">üìç</span> Sede Principal en Miami, USA
                            </h3>
                            <p class="text-gray-600">Nuestra sede estrat√©gica se encuentra en el vibrante centro de innovaci√≥n tecnol√≥gica y financiera, **Miami, Florida, EE. UU.**, lo que nos permite estar a la vanguardia de las regulaciones y tendencias del mercado global. Nuestro equipo de gesti√≥n opera desde esta ubicaci√≥n privilegiada.</p>
                            <div class="bg-gray-50 p-4 rounded-lg mt-4 text-sm">
                                <p class="font-semibold text-gray-700">Direcci√≥n Operativa:</p>
                                <p class="text-gray-500">Brickell Financial District, Miami, Florida, 33131, USA.</p>
                            </div>
                        </div>
                    </div>
                </section>
                
            </div>

            <!-- VISTA DE AUTENTICACI√ìN (LOGIN/REGISTER) -->
            <div id="auth-view" class="hidden">
                <!-- El contenido de login/registro se inserta aqu√≠ -->
            </div>

            <!-- VISTA DE DASHBOARD -->
            <div id="dashboard-view" class="hidden">
                <!-- El contenido del dashboard se inserta aqu√≠ din√°micamente -->
            </div>
            
            <!-- NUEVA VISTA DE REFERIDOS -->
            <div id="referrals-view" class="hidden">
                <!-- El contenido de referidos se inserta aqu√≠ din√°micamente -->
            </div>
        </div>

        <!-- Informaci√≥n de Referido (Link y C√≥digo) - Se usa en Dashboard y Referrals -->
        <div id="user-referral-info" class="hidden text-center mt-8 p-4 bg-blue-100 rounded-lg max-w-xl mx-auto">
            <h3 class="text-xl font-bold text-blue-900 mb-3">¬°Comparta y Gane el 10% de Bono!</h3>

            <!-- Link de Referido -->
            <p class="text-sm font-medium text-blue-600">Su Link de Referido √önico:</p>
            <div class="flex items-center space-x-2 mt-1 bg-blue-200 p-2 rounded-lg">
                <span id="referral-link-display" class="link-display font-mono text-blue-900 flex-grow text-left"></span>
                <button type="button" onclick="copyReferralInfo('link')" class="p-1 bg-blue-300 rounded-md hover:bg-blue-400 text-blue-900 transition duration-150 text-sm font-semibold">
                    Copiar Link
                </button>
            </div>
            
            <!-- C√≥digo de Referido (UID) -->
            <p class="text-sm font-medium text-blue-600 mt-3">... o use su C√≥digo (UID):</p>
            <div class="flex items-center space-x-2 mt-1 bg-blue-200 p-2 rounded-lg">
                <span id="referral-code-display" class="text-lg font-mono text-blue-900 break-all flex-grow text-left"></span>
                <button type="button" onclick="copyReferralInfo('code')" class="p-1 bg-blue-300 rounded-md hover:bg-blue-400 text-blue-900 transition duration-150 text-sm font-semibold">
                    Copiar C√≥digo
                </button>
            </div>
            <p class="text-xs text-blue-700 mt-3">Este link/c√≥digo incluye autom√°ticamente su ID de usuario.</p>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-gray-800 text-white mt-12 py-6">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2024 Alpha Market. Sede en Miami, EE. UU. | Invertir conlleva riesgo de p√©rdida de capital.</p>
        </div>
    </footer>

    <!-- INICIALIZACI√ìN Y L√ìGICA DE FIREBASE Y PLATAFORMA -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, setLogLevel, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de registro de Firebase (MANDATORIO para depuraci√≥n)
        setLogLevel('debug');

        // --- Configuraci√≥n Global de Inversi√≥n ---
        const WALLET_INFO = {
            'USDT BEP20': { address: '0x3a0b76c620f77015b39284986e2f4a2af6358e3f', network: 'Binance Smart Chain (BEP20)' },
            'USDT TRC20': { address: 'TDD2h4H8x3wiAGnaJN2FD6khogA1F9WLwb', network: 'TRON (TRC20)' }
        };
        const MIN_DEPOSIT = 15.00;
        const DAILY_RETURN_RATE = 0.20; 
        const REFERRAL_BONUS_RATE = 0.10; // 10% del dep√≥sito del referido
        
        // URL BASE PARA EL LINK DE REFERIDO
        const BASE_URL = "https://alphamarket.io/register"; 

        // --- Variables Globales y Configuraci√≥n de Firebase ---
        let db;
        let auth;
        let currentUser = null;
        let currentBalance = 0.00;
        let totalRealGain = 0.00; 
        let currentUserName = ''; // Nuevo campo para Nombre y Apellido

        // Variables globales proporcionadas por el entorno (MANDATORIO USAR)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-alphamarket-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "MOCK_KEY", authDomain: "MOCK_DOMAIN", projectId: "MOCK_PROJECT" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Utilidades UI ---
        const loadingIndicator = document.getElementById('loading-initial');
        const homeView = document.getElementById('home-view');
        const authView = document.getElementById('auth-view');
        const dashboardView = document.getElementById('dashboard-view');
        const referralsView = document.getElementById('referrals-view');
        const userReferralInfo = document.getElementById('user-referral-info');
        const referralLinkDisplay = document.getElementById('referral-link-display');
        const referralCodeDisplay = document.getElementById('referral-code-display');
        const menuModal = document.getElementById('menu-modal');
        const menuDrawer = document.getElementById('menu-drawer');
        const userDisplayNameEmail = document.getElementById('user-display-name-email');
        const menuDashboardLink = document.getElementById('menu-dashboard-link');
        const menuReferralsLink = document.getElementById('menu-referrals-link');


        /**
         * Maneja la navegaci√≥n y cierra el men√∫ lateral.
         */
        window.menuNavigate = (viewName) => {
            toggleMenu(false); // Cierra el men√∫ al navegar
            navigateToView(viewName);
        };
        
        /**
         * Abre o cierra el men√∫ lateral (Hamburguer Menu).
         */
        window.toggleMenu = (show) => {
            if (show) {
                menuModal.classList.remove('hidden');
                menuModal.classList.add('flex');
                setTimeout(() => menuDrawer.classList.remove('translate-x-full'), 10);
            } else {
                menuDrawer.classList.add('translate-x-full');
                setTimeout(() => menuModal.classList.add('hidden'), 300); // Espera la transici√≥n CSS
            }
        };

        /**
         * Navega a una vista espec√≠fica (SPA routing).
         * @param {string} viewName - 'home', 'login', 'register', 'dashboard', or 'referrals'.
         */
        window.navigateToView = (viewName) => {
            homeView.classList.add('hidden');
            authView.classList.add('hidden');
            dashboardView.classList.add('hidden');
            referralsView.classList.add('hidden');
            userReferralInfo.classList.add('hidden');

            const isAuthenticated = currentUser && !currentUser.isAnonymous;

            switch (viewName) {
                case 'home':
                    homeView.classList.remove('hidden');
                    break;
                case 'login':
                case 'register':
                    if (isAuthenticated) { 
                        navigateToView('dashboard'); 
                        return;
                    }
                    authView.classList.remove('hidden');
                    renderAuthForms(viewName);
                    break;
                case 'dashboard':
                    if (isAuthenticated) {
                        dashboardView.classList.remove('hidden');
                        renderReferralInfo(); // Muestra el link/c√≥digo
                        renderDashboard();
                    } else {
                        navigateToView('login'); 
                    }
                    break;
                case 'referrals':
                    if (isAuthenticated) {
                        referralsView.classList.remove('hidden');
                        renderReferralInfo(); // Muestra el link/c√≥digo
                        renderReferralsView();
                    } else {
                        navigateToView('login');
                    }
                    break;
                default:
                    homeView.classList.remove('hidden');
            }
        };

        /** Muestra el modal de mensajes personalizado. (Reemplaza a alert()) */
        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-container').classList.remove('hidden');
            document.getElementById('modal-container').classList.add('flex');
        };
        window.hideModal = () => {
            document.getElementById('modal-container').classList.add('hidden');
            document.getElementById('modal-container').classList.remove('flex');
        };

        // Funciones para el Modal de Dep√≥sito
        window.showDepositModal = () => {
            if (!currentUser || currentUser.isAnonymous) {
                showModal("Acceso Requerido", "Debes iniciar sesi√≥n para acceder al dep√≥sito.");
                return;
            }
            document.getElementById('deposit-modal-container').classList.remove('hidden');
            document.getElementById('deposit-modal-container').classList.add('flex');
            document.getElementById('deposit-form').reset();
            document.getElementById('wallet-details').classList.add('hidden');
            document.getElementById('wallet-address-display').textContent = '';
            document.getElementById('selected-network').textContent = '';
        };

        window.hideDepositModal = () => {
            document.getElementById('deposit-modal-container').classList.add('hidden');
            document.getElementById('deposit-modal-container').classList.remove('flex');
        };
        
        window.copyWalletAddress = () => {
            const address = document.getElementById('wallet-address-display').textContent;
            if (address) {
                const tempInput = document.createElement('input');
                tempInput.value = address;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    showModal('Copiado', '¬°Direcci√≥n de billetera copiada al portapapeles!');
                } catch (err) {
                    showModal('Error al Copiar', 'No se pudo copiar la direcci√≥n.');
                }
                document.body.removeChild(tempInput);
            }
        };
        
        /**
         * Copia el link o el c√≥digo de referido al portapapeles.
         * @param {'link'|'code'} type - El tipo de informaci√≥n a copiar.
         */
        window.copyReferralInfo = (type) => {
            const element = type === 'link' ? referralLinkDisplay : referralCodeDisplay;
            const info = element.textContent;
            
            if (info) {
                const tempInput = document.createElement('input');
                tempInput.value = info;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    const message = type === 'link' ? 'Link de Referido copiado.' : 'C√≥digo de Referido copiado.';
                    showModal('Copiado', message);
                } catch (err) {
                    showModal('Error al Copiar', 'No se pudo copiar la informaci√≥n autom√°ticamente.');
                }
                document.body.removeChild(tempInput);
            }
        };

        window.updateWalletAddress = () => {
            const network = document.getElementById('deposit-network').value;
            const detailsDiv = document.getElementById('wallet-details');
            const addressDisplay = document.getElementById('wallet-address-display');
            const selectedNetwork = document.getElementById('selected-network');

            if (network && WALLET_INFO[network]) {
                const info = WALLET_INFO[network];
                addressDisplay.textContent = info.address;
                selectedNetwork.textContent = info.network;
                detailsDiv.classList.remove('hidden');
            } else {
                detailsDiv.classList.add('hidden');
                addressDisplay.textContent = '';
                selectedNetwork.textContent = '';
            }
        };


        // --- L√≥gica de Inicializaci√≥n y Auth ---
        
        const initializeAppAndAuth = async () => {
            try {
                // 1. Inicializar servicios de Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Autenticaci√≥n Inicial
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Listener de Estado de Autenticaci√≥n
                onAuthStateChanged(auth, async (user) => {
                    loadingIndicator.classList.add('hidden');

                    if (user && !user.isAnonymous) {
                        currentUser = user;
                        // Forzamos la carga del nombre al iniciar sesi√≥n para el men√∫
                        await fetchAndSetUserData(user.uid); 
                        renderMenuControls(true, user.email);
                        // Carga la vista de HOME SIEMPRE al inicio
                        navigateToView('home'); 
                        
                    } else {
                        currentUser = user; 
                        currentUserName = '';
                        renderMenuControls(false);
                        // Navega a la p√°gina de inicio (Landing Page)
                        navigateToView('home'); 
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                loadingIndicator.textContent = 'Error al cargar la plataforma. Revise la consola.';
                showModal('Error de Carga', `No se pudo iniciar la plataforma. Detalles: ${error.message}`);
            }
        };

        /**
         * Fetches user's name and last name from Firestore and updates global variable.
         */
        const fetchAndSetUserData = async (uid) => {
            try {
                const docRef = getInvestmentDocRef(uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const name = data.name || '';
                    const lastName = data.lastName || '';
                    currentUserName = `${name} ${lastName}`.trim();
                } else {
                    currentUserName = '';
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
                currentUserName = '';
            }
        };

        // --- Utilidades de Firestore y L√≥gica de Crecimiento ---

        const getInvestmentDocRef = (uid) => {
            // Ruta privada: /artifacts/{appId}/users/{userId}/inversiones/balance
            return doc(db, `artifacts/${appId}/users/${uid}/inversiones`, 'balance');
        };
        
        /**
         * Busca usuarios que tienen como referente el ID del usuario actual. (MOCK)
         */
        const fetchReferrals = async (referrerId) => {
            if (!db) return [];
            
            // MOCK DE DATOS DE REFERIDOS (Simulaci√≥n funcional)
            if (referrerId === currentUser.uid) {
                 return [
                    { id: '12345678', name: 'Juan', lastName: 'Perez', joined: '2025-01-10', deposit: 100.00 },
                    { id: '90123456', name: 'Maria', lastName: 'Gomez', joined: '2025-02-15', deposit: 50.00 },
                    { id: '78901234', name: 'Pedro', lastName: 'Lopez', joined: '2025-03-20', deposit: 250.00 },
                ];
            } else {
                return [];
            }
        };

        /**
         * Genera el link de referido completo.
         */
        const generateReferralLink = (uid) => {
            return `${BASE_URL}?ref=${uid}`;
        };

        /**
         * Calcula el nuevo balance aplicando el crecimiento diario del 20% desde la √∫ltima actualizaci√≥n.
         */
        const calculateDailyGrowth = (amount, lastUpdateIso) => {
            if (amount <= 0) return { newBalance: 0, gain: 0 };
            
            const lastUpdate = new Date(lastUpdateIso);
            const now = new Date();
            
            const diffMs = now - lastUpdate;
            const msInDay = 1000 * 60 * 60 * 24;
            const daysPassed = Math.floor(diffMs / msInDay); 
            
            if (daysPassed <= 0) return { newBalance: amount, gain: 0 }; 

            let newBalance = amount;
            
            // F√≥rmula de inter√©s compuesto diario al 20%
            newBalance = amount * Math.pow((1 + DAILY_RETURN_RATE), daysPassed);
            
            const gain = newBalance - amount;
            
            return { newBalance: parseFloat(newBalance.toFixed(2)), gain: parseFloat(gain.toFixed(2)) };
        };

        /**
         * Aplica y guarda el crecimiento del 20% diario si ha pasado al menos un d√≠a.
         */
        const updateBalanceWithGrowth = async (uid, currentData) => {
            const balance = currentData.amount || 0.00;
            const lastUpdate = currentData.lastUpdate || new Date().toISOString();
            const currentGain = currentData.totalRealGain || 0.00; 

            const { newBalance, gain } = calculateDailyGrowth(balance, lastUpdate);
            
            if (gain > 0) {
                const userDocRef = getInvestmentDocRef(uid);
                
                await setDoc(userDocRef, {
                    amount: newBalance,
                    lastUpdate: new Date().toISOString(), 
                    totalRealGain: currentGain + gain,
                }, { merge: true });

                console.log(`Crecimiento del 20% aplicado: +$${gain.toFixed(2)} USDT.`);
            }
        };


        // --- L√≥gica de Renderizado de Vistas ---

        const renderReferralInfo = () => {
             if (!currentUser || currentUser.isAnonymous) return;
             
             const uid = currentUser.uid;
             referralLinkDisplay.textContent = generateReferralLink(uid);
             referralCodeDisplay.textContent = uid;
             userReferralInfo.classList.remove('hidden');
        };

        const renderDashboard = () => {
            // El contenido del dashboard ya est√° en el archivo anterior, solo lo renderizamos.
            dashboardView.innerHTML = `
                <div class="card-bg p-8 sm:p-10">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-6 alpha-text-gradient">
                        Panel del Inversor Alpha
                    </h2>

                    <!-- Informaci√≥n de Inversi√≥n y Rendimiento -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Balance Total -->
                        <div class="p-5 bg-blue-50 rounded-xl border border-blue-200">
                            <p class="text-sm font-medium text-blue-600">Balance Total (USDT)</p>
                            <p id="current-balance" class="text-3xl font-bold text-blue-900 mt-1">$${currentBalance.toFixed(2)}</p>
                        </div>
                        <!-- Rendimiento Real -->
                        <div class="p-5 bg-green-50 rounded-xl border border-green-200">
                            <p class="text-sm font-medium text-green-600">Ganancia Acumulada</p>
                            <p id="total-gain-display" class="text-3xl font-bold text-green-700 mt-1">$${totalRealGain.toFixed(2)}</p>
                        </div>
                         <!-- Tasa de Retorno -->
                        <div class="p-5 bg-yellow-50 rounded-xl border border-yellow-200">
                            <p class="text-sm font-medium text-yellow-600">Tasa de Rendimiento</p>
                            <p class="text-3xl font-bold text-yellow-800 mt-1">${(DAILY_RETURN_RATE * 100).toFixed(0)}% Diario</p>
                        </div>
                    </div>

                    <!-- SECCI√ìN DE PLANES Y DEP√ìSITO -->
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Planes de Inversi√≥n Alpha Crypto</h3>
                        
                        <p class="text-md text-green-700 font-semibold mb-4 p-3 bg-green-100 rounded-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-600" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            RENDIMIENTO REAL: Su balance crece un ${(DAILY_RETURN_RATE * 100).toFixed(0)}% diariamente.
                        </p>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                            <div class="p-4 bg-gray-100 rounded-lg border border-gray-300">
                                <h4 class="text-lg font-bold text-blue-800">Plan Inicial</h4>
                                <p class="text-sm text-gray-600">Inversi√≥n de $15 - $999 USDT</p>
                            </div>
                            <div class="p-4 bg-gray-100 rounded-lg border border-gray-300">
                                <h4 class="text-lg font-bold text-blue-800">Plan Estrat√©gico</h4>
                                <p class="text-sm text-gray-600">Inversi√≥n de $1,000 USDT en adelante</p>
                            </div>
                        </div>

                        <button onclick="showDepositModal()" class="w-full py-3 text-lg text-white font-bold rounded-lg bg-green-600 hover:bg-green-700 transition duration-200 shadow-md">
                            Depositar Fondos Ahora (USDT)
                        </button>
                    </div>
                </div>
            `;
            
            if (currentUser && db) {
                listenToBalance();
            }
        };
        
        const renderReferralsView = async () => {
            referralsView.innerHTML = `
                <div class="card-bg p-8 sm:p-10">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-6 alpha-text-gradient">
                        Mi Red de Referidos (10% de Bono)
                    </h2>
                    
                    <!-- El link de referido se muestra arriba, en user-referral-info -->

                    <!-- Lista de Referidos -->
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 mt-8">
                        Clientes Referidos por Usted
                    </h3>
                    <div id="referrals-list" class="space-y-3">
                        <div class="text-center py-8 text-gray-500" id="referrals-loading">Cargando lista de referidos...</div>
                    </div>
                </div>
            `;
            
            const listContainer = document.getElementById('referrals-list');
            const loadingIndicator = document.getElementById('referrals-loading');
            
            try {
                const referrals = await fetchReferrals(currentUser.uid);
                
                if (referrals.length === 0) {
                    listContainer.innerHTML = `
                        <div class="p-4 bg-yellow-50 rounded-lg text-yellow-700 border border-yellow-200 text-center">
                            A√∫n no tiene clientes registrados con su c√≥digo. ¬°Comparta su Link/C√≥digo!
                        </div>
                    `;
                } else {
                    listContainer.innerHTML = ''; // Limpiar el indicador de carga
                    referrals.forEach(ref => {
                        const date = new Date(ref.joined).toLocaleDateString();
                        const fullName = `${ref.name} ${ref.lastName}`;
                        const item = document.createElement('div');
                        item.className = 'p-4 bg-gray-50 rounded-lg flex justify-between items-center border border-gray-200 hover:bg-gray-100 transition duration-150';
                        item.innerHTML = `
                            <div>
                                <p class="font-bold text-gray-800">${fullName}</p>
                                <p class="text-xs text-gray-500">ID: ${ref.id} | Registrado: ${date}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-green-600">Dep√≥sito Inicial (MOCK)</p>
                                <p class="text-lg font-bold text-green-800">$${ref.deposit ? ref.deposit.toFixed(2) : '0.00'}</p>
                            </div>
                        `;
                        listContainer.appendChild(item);
                    });
                }
            } catch (error) {
                console.error("Error al obtener referidos:", error);
                listContainer.innerHTML = `<div class="p-4 bg-red-100 rounded-lg text-red-700">Error al cargar la red de referidos.</div>`;
            }
        };

        // Escucha en tiempo real los cambios en el balance del usuario
        const listenToBalance = () => {
            const userDocRef = getInvestmentDocRef(currentUser.uid);
            
            onSnapshot(userDocRef, async (docSnapshot) => {
                let data = {};
                if (docSnapshot.exists()) {
                    data = docSnapshot.data();
                }

                if (!currentUser.isAnonymous) {
                    await updateBalanceWithGrowth(currentUser.uid, data);
                    
                    // Actualizar nombre global y men√∫
                    const name = data.name || '';
                    const lastName = data.lastName || '';
                    currentUserName = `${name} ${lastName}`.trim();
                    renderMenuControls(true, currentUser.email);
                }
                
                currentBalance = data.amount || 0.00;
                totalRealGain = data.totalRealGain || 0.00; 

                const balanceElement = document.getElementById('current-balance');
                const gainElement = document.getElementById('total-gain-display');

                if (balanceElement && gainElement) {
                    balanceElement.textContent = `$${currentBalance.toFixed(2)}`;
                    gainElement.textContent = `$${totalRealGain.toFixed(2)}`;
                }
            }, (error) => {
                console.error("Error al escuchar el balance:", error);
            });
        };

        // --- L√≥gica de Autenticaci√≥n (Auth) y Datos (Firestore) ---

        const handleAuthSubmit = async (e, isLogin) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('auth-submit-btn');

            btn.innerHTML = '<div class="loading-ring"></div>';
            btn.disabled = true;

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                    showModal('Inicio Exitoso', '¬°Bienvenido de nuevo! Redirigiendo al panel.');
                    navigateToView('dashboard'); 
                } else {
                    // Campos adicionales para el registro
                    const name = document.getElementById('name').value;
                    const lastName = document.getElementById('lastName').value;
                    const referrerId = document.getElementById('referral-code')?.value || null; 

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const uid = userCredential.user.uid;

                    let userData = {
                        amount: 0.00,
                        lastUpdate: new Date().toISOString(),
                        totalRealGain: 0.00,
                        email: email, 
                        name: name, // Guardar Nombre
                        lastName: lastName, // Guardar Apellido
                    };
                    
                    let successMessage = `¬°Bienvenido ${name}! Te has registrado con √©xito.`;
                    
                    if (referrerId && referrerId !== uid) {
                        const referrerDocRef = getInvestmentDocRef(referrerId);
                        const referrerDoc = await getDoc(referrerDocRef);
                        
                        // Solo aceptamos el c√≥digo si existe el documento del referente
                        if (referrerDoc.exists() && referrerDoc.data().amount !== undefined) {
                            userData.referrerId = referrerId;
                            successMessage += ` C√≥digo de referido (${referrerId.substring(0, 8)}...) aceptado.`;
                        } else {
                            successMessage += ` C√≥digo de referido inv√°lido o no encontrado.`;
                        }
                    }

                    await setDoc(getInvestmentDocRef(uid), userData, { merge: true });
                    showModal('Registro Exitoso', successMessage + ' Redirigiendo al panel.');
                    navigateToView('dashboard'); 
                }
            } catch (error) {
                console.error("Error de autenticaci√≥n:", error);
                let errorMessage = "Ocurri√≥ un error. Intente de nuevo.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Este email ya est√° registrado. Intente iniciar sesi√≥n.";
                } else if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Credenciales inv√°lidas. Email o contrase√±a incorrectos.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "La contrase√±a debe tener al menos 6 caracteres.";
                }
                showModal('Error de Autenticaci√≥n', errorMessage);
            } finally {
                btn.innerHTML = `<span>${isLogin ? 'Iniciar Sesi√≥n' : 'Registrarse'}</span>`;
                btn.disabled = false;
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                showModal('Adi√≥s', 'Ha cerrado sesi√≥n exitosamente.');
                // Redirige al Home despu√©s de cerrar sesi√≥n
                navigateToView('home'); 
            } catch (error) {
                console.error("Error al cerrar sesi√≥n:", error);
                showModal('Error al Cerrar Sesi√≥n', 'No se pudo cerrar la sesi√≥n. Intente de nuevo.');
            }
        };

        // --- L√≥gica de Renderizado de Men√∫ y Formularios ---

        const renderMenuControls = (isLoggedIn, email = null) => {
            const authMenuLinks = document.getElementById('auth-menu-links');
            
            menuDashboardLink.classList.add('hidden');
            menuReferralsLink.classList.add('hidden');
            authMenuLinks.innerHTML = '';
            
            // L√≥gica de Display de Usuario en el Men√∫
            if (isLoggedIn) {
                const displayName = currentUserName ? currentUserName : email;
                userDisplayNameEmail.innerHTML = `<span class="font-bold">${displayName}</span>`;

                // Usuario Logueado
                menuDashboardLink.classList.remove('hidden');
                menuReferralsLink.classList.remove('hidden');

                authMenuLinks.innerHTML = `
                    <button onclick="handleLogout(); toggleMenu(false);" class="w-full p-3 text-left font-bold text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Cerrar Sesi√≥n
                    </button>
                `;
            } else {
                // Usuario Deslogueado
                userDisplayNameEmail.textContent = 'Inicie sesi√≥n o reg√≠strese';
                authMenuLinks.innerHTML = `
                    <a href="#" onclick="menuNavigate('login')" class="p-3 text-blue-600 hover:bg-blue-100 rounded-lg transition duration-150 flex items-center border border-blue-600">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-1a3 3 0 013-3h7"></path></svg>
                        Iniciar Sesi√≥n
                    </a>
                    <a href="#" onclick="menuNavigate('register')" class="p-3 text-white font-bold alpha-gradient rounded-lg hover:opacity-90 transition duration-150 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                        Registrarse
                    </a>
                `;
            }
        };


        const renderAuthForms = (mode) => {
            const isLogin = mode === 'login';
            
            // Campos adicionales para el registro (solo si no es login)
            const kycFields = isLogin ? '' : `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="name" required placeholder="Su Nombre" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700">Apellidos</label>
                        <input type="text" id="lastName" required placeholder="Sus Apellidos" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            `;
            
            // El c√≥digo de referido es opcional SOLO en el registro
            const referralField = isLogin ? '' : `
                <div>
                    <label for="referral-code" class="block text-sm font-medium text-gray-700">C√≥digo de Referido (Opcional)</label>
                    <input type="text" id="referral-code" placeholder="ID del usuario que te refiri√≥" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 uppercase">
                    <p class="text-xs text-gray-500 mt-1">Si es v√°lido, obtendr√°s un 10% de bono en tu primer dep√≥sito.</p>
                </div>
            `;

            authView.innerHTML = `
                <div class="max-w-md mx-auto p-8 card-bg">
                    <h2 class="text-3xl font-extrabold text-gray-900 text-center mb-6 alpha-text-gradient">
                        ${isLogin ? 'Iniciar Sesi√≥n' : 'Crear Cuenta Alpha Market'}
                    </h2>
                    <form id="auth-form" class="space-y-4">
                        ${kycFields}
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                            <input type="password" id="password" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        ${referralField}
                        <button type="submit" id="auth-submit-btn" class="w-full py-3 text-white font-bold rounded-lg alpha-gradient hover:opacity-90 transition duration-200 flex justify-center items-center space-x-2">
                            <span>${isLogin ? 'Iniciar Sesi√≥n' : 'Registrarse'}</span>
                        </button>
                    </form>
                    <button onclick="navigateToView('${isLogin ? 'register' : 'login'}')" class="mt-4 w-full text-sm text-blue-600 hover:text-blue-800 transition duration-200">
                        ${isLogin ? '¬øNo tienes cuenta? Reg√≠strate aqu√≠.' : '¬øYa tienes cuenta? Inicia sesi√≥n aqu√≠.'}
                    </button>
                    <button onclick="navigateToView('home')" class="mt-4 w-full text-sm text-gray-500 hover:text-gray-700 transition duration-200">
                        Volver a Inicio
                    </button>
                </div>
            `;
            document.getElementById('auth-form').addEventListener('submit', (e) => handleAuthSubmit(e, isLogin));
        };
        
        // Maneja la Confirmaci√≥n de Dep√≥sito 
        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputAmount = document.getElementById('deposit-amount');
            const network = document.getElementById('deposit-network').value;
            const newDeposit = parseFloat(inputAmount.value);
            const btn = document.getElementById('deposit-submit-btn');
            const btnText = document.getElementById('deposit-submit-text');
            const spinner = document.getElementById('deposit-submit-spinner');

            if (isNaN(newDeposit) || newDeposit < MIN_DEPOSIT) {
                showModal('Error de Dep√≥sito', `El monto m√≠nimo de inversi√≥n es $${MIN_DEPOSIT.toFixed(2)} USDT.`);
                return;
            }
            if (!network) {
                showModal('Error de Dep√≥sito', 'Por favor, seleccione una red de dep√≥sito (BEP20 o TRC20).');
                return;
            }
            if (!currentUser || currentUser.isAnonymous) {
                showModal('Error de Autenticaci√≥n', 'La sesi√≥n ha expirado. Por favor, inicie sesi√≥n de nuevo.');
                return;
            }

            btnText.textContent = 'Procesando...';
            spinner.classList.remove('hidden');
            btn.disabled = true;

            try {
                await new Promise(resolve => setTimeout(resolve, 2000)); 

                const userDocRef = getInvestmentDocRef(currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                const userData = userDoc.exists() ? userDoc.data() : { amount: 0, totalRealGain: 0, lastUpdate: new Date().toISOString() };

                const updatedBalance = parseFloat((userData.amount + newDeposit).toFixed(2));
                let depositMessage = `Se han a√±adido $${newDeposit.toFixed(2)} USDT a su cuenta a trav√©s de la red ${network}.`;

                // L√≥gica de bono por referido
                if (userData.referrerId) {
                    const referrerId = userData.referrerId;
                    const referrerDocRef = getInvestmentDocRef(referrerId);
                    const referrerDoc = await getDoc(referrerDocRef);
                    
                    if (referrerDoc.exists()) { 
                        const referrerData = referrerDoc.data();
                        const bonusAmount = parseFloat((newDeposit * REFERRAL_BONUS_RATE).toFixed(2));
                        const referrerNewBalance = parseFloat((referrerData.amount + bonusAmount).toFixed(2));
                        
                        // Guardar el bono al referente
                        await setDoc(referrerDocRef, {
                            amount: referrerNewBalance,
                            lastReferralBonus: bonusAmount,
                            // Los campos name/lastName NO se tocan
                        }, { merge: true });

                        depositMessage += ` Adem√°s, su referente (${referrerId.substring(0, 8)}...) ha recibido un bono.`;
                    }
                    
                    // Solo eliminar el referrerId si fue utilizado una vez
                    userData.referrerId = null; 
                }

                // Guardar el nuevo balance
                await setDoc(userDocRef, {
                    amount: updatedBalance,
                    lastDeposit: newDeposit,
                    lastNetwork: network,
                    lastUpdate: new Date().toISOString(), 
                    userId: currentUser.uid,
                    referrerId: userData.referrerId 
                }, { merge: true });

                hideDepositModal();
                showModal('¬°Dep√≥sito Exitoso!', `${depositMessage} Su nuevo balance es $${updatedBalance.toFixed(2)}. ¬°Disfrute del ${DAILY_RETURN_RATE * 100}% de rendimiento diario REAL!`);
                inputAmount.value = '';

            } catch (error) {
                console.error("Error al procesar el dep√≥sito/referido:", error);
                showModal('Error de Transacci√≥n', `No se pudo procesar la transacci√≥n. Detalles: ${error.message}`);
            } finally {
                btnText.textContent = 'Confirmar Dep√≥sito';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        });


        // --- Inicio de la Aplicaci√≥n ---
        window.onload = initializeAppAndAuth;

    </script>
</body>
</html>
